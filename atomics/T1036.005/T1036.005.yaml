---
attack_technique: T1036.005
display_name: Masquerading: Match Legitimate Name or Location
author: Furkan Celik

atomic_tests:
- name: Masquerading cmd.exe as VSDetector.exe
  auto_generated_guid: # CI tarafÄ±ndan otomatik doldurulacak
  description: |
    This test simulates an adversary renaming cmd.exe to VSDetector.exe to masquerade as a legitimate application.
    The test copies cmd.exe, renames it to VSDetector.exe, adds a registry run key for persistence, and executes the renamed binary.
    This technique may be used to evade detection by mimicking legitimate software names or locations.

    **Expected Output:**
    - A new process named VSDetector.exe appears in the process list, but its behavior matches cmd.exe.
    - SIEM/EDR systems may detect this as suspicious process activity (e.g., Sysmon Event ID 1 for process creation, or Event ID 13 for registry modifications).
    - Registry modification in HKLM:\Software\Microsoft\Windows\CurrentVersion\Run may trigger persistence alerts in XDR platforms.

    **References:**
    - [MITRE ATT&CK T1036.005](https://attack.mitre.org/techniques/T1036/005/)
    - [Sysmon Process Creation](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)

  supported_platforms:
    - windows

  input_arguments:
    vsd_path:
      description: Directory path where VSDetector.exe will be created
      type: Path
      default: $env:TEMP
    source_file:
      description: Path to the source cmd.exe file
      type: Path
      default: $env:SystemRoot\System32\cmd.exe

  dependency_executor_name: powershell
  dependencies:
    - description: |
        The source cmd.exe file must exist on the system.
      prereq_command: |
        if (Test-Path "#{source_file}") { exit 0 } else { exit 1 }
      get_prereq_command: |
        Write-Host "[-] Source file not found: #{source_file}. Ensure cmd.exe exists in the specified path."
        exit 1

  executor:
    name: powershell
    elevation_required: true
    command: |
      # Copy and rename cmd.exe to VSDetector.exe
      Copy-Item -Path "#{source_file}" -Destination "#{vsd_path}\VSDetector.exe" -Force
      
      # Create registry run key for persistence
      New-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "VSDetector" -Value "#{vsd_path}\VSDetector.exe" -PropertyType String -Force
      
      # Start the renamed process
      Start-Process -FilePath "#{vsd_path}\VSDetector.exe"
      
      Start-Sleep -Seconds 5
    cleanup_command: |
      # Remove registry key
      Remove-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "VSDetector" -ErrorAction SilentlyContinue
      
      # Stop the process
      Stop-Process -Name "VSDetector" -Force -ErrorAction SilentlyContinue
      
      # Remove the file
      Remove-Item -Path "#{vsd_path}\VSDetector.exe" -Force -ErrorAction SilentlyContinue
      
      Write-Host "[+] Cleaned up VSDetector artifacts"