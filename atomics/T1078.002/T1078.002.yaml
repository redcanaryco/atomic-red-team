attack_technique: T1078.002
display_name: 'Valid Accounts: Domain Accounts'
atomic_tests:
- name: Active Directory Add Domain Account Using LDAP
  auto_generated_guid: 
  description: |
    Output information from LDAPSearch. LDAP Password is the admin-user password on Active Directory
  supported_platforms:
  - linux
  input_arguments:
    domain:
      description: The domain to be tested
      type: string
      default: example
    top_level_domain:
      description: The top level domain (.com, .test, .remote, etc... following domain, minus the .)
      type: string
      default: test
    admin_user:
      description: username@domain of a user with admin privileges
      type: string
      default: admin@example.test
    admin_password:
      description: password of the user with admin privileges referenced in admin_user
      type: string
      default: s3CurePssw0rD!
    domain_controller:
      description: Name of the domain_controller machine, defined in etc/hosts
      type: string
      default: adVM
  dependency_executor_name: sh
  dependencies:
  - description: |
      Packages sssd-ad sssd-tools realmd adcli installed and realm available
    prereq_command: |
      dpkg -s sssd-ad | grep -q installed
      dpkg -s sssd-tools | grep -q installed
      dpkg -s realmd | grep -q installed
      dpkg -s adcli | grep -q installed
    get_prereq_command: |
      apt-get install -y sssd-ad sssd-tools relamd adcli
  executor:
    elevation_required: false
    command: |
       echo "dn: uid=1111,cn=Users,dc=#{domain},dc=#{top_level_domain}\nchangetype: add\nobjectClass: inetOrgPerson\ndescription: tempuser\ncn: John Smith\nsn: Smith\nuid: jsmith1" > tempadmin.ldif
       ldapadd -h #{domain_controller} -p 389 -x -D #{admin_user} -w #{admin_password} -f tempadmin.ldif
    cleanup_command:
    name: sh
