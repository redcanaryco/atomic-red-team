---
attack_technique: T1118
display_name: InstallUtil

atomic_tests:
- name: InstallUtil CheckIfInstallable method call
  description: |
    Executes the CheckIfInstallable class constructor runner instead of executing InstallUtil.
  supported_platforms:
    - windows
  input_arguments:
    test_harness:
      description: location of the test harness script - Invoke-BuildAndInvokeInstallUtilAssembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\InstallUtilTestHarness.ps1
    payload_dir:
      description: directory to drop the compiled installer assembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\
    payload_filename:
      description: filename of the compiled installer assembly
      type: String
      default: T1118.dll
    invocation_method:
      description: the type of InstallUtil invocation variant - Executable, InstallHelper, or CheckIfInstallable
      type: String
      default: CheckIfInstallable
  executor:
    name: powershell
    elevation_required: false
    command: |
      # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
      . #{test_harness}

      $PayloadDirectory = '#{payload_dir}'
      $PayloadFileName = '#{payload_filename}'
      $PayloadFullPath = Join-Path -Path $PayloadDirectory -ChildPath $PayloadFileName

      $ExpectedPayloadOutput = 'Constructor_'

      $TestArgs = @{
          OutputAssemblyDirectory = $PayloadDirectory
          OutputAssemblyFileName = $PayloadFileName
          InvocationMethod = '#{invocation_method}'
      }

      $PayloadOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs -MinimumViablePayload

      if ($PayloadOutput -ne $ExpectedPayloadOutput) {
          throw @"
      CheckIfInstallable method execution test failure. Payload execution output did not match the expected output.
      Expected: $ExpectedPayloadOutput
      Actual: $PayloadOutput
      "@
      }
- name: InstallUtil InstallHelper method call
  description: |
    Executes the InstallHelper class constructor runner instead of executing InstallUtil.
  supported_platforms:
    - windows
  input_arguments:
    test_harness:
      description: location of the test harness script - Invoke-BuildAndInvokeInstallUtilAssembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\InstallUtilTestHarness.ps1
    payload_dir:
      description: directory to drop the compiled installer assembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\
    payload_filename:
      description: filename of the compiled installer assembly
      type: String
      default: T1118.dll
    invocation_method:
      description: the type of InstallUtil invocation variant - Executable, InstallHelper, or CheckIfInstallable
      type: String
      default: InstallHelper
  executor:
    name: powershell
    elevation_required: false
    command: |
      # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
      . #{test_harness}

      $PayloadDirectory = '#{payload_dir}'
      $PayloadFileName = '#{payload_filename}'
      $PayloadFullPath = Join-Path -Path $PayloadDirectory -ChildPath $PayloadFileName

      $CommandLine = "/logfile= /logtoconsole=false `"$PayloadFullPath`""
      $ExpectedPayloadOutput = 'Constructor_'

      $TestArgs = @{
          OutputAssemblyDirectory = $PayloadDirectory
          OutputAssemblyFileName = $PayloadFileName
          InvocationMethod = '#{invocation_method}'
          CommandLine = $CommandLine
      }

      $PayloadOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs -MinimumViablePayload

      if ($PayloadOutput -ne $ExpectedPayloadOutput) {
          throw @"
      InstallHelper method execution test failure. Payload execution output did not match the expected output.
      Expected: $ExpectedPayloadOutput
      Actual: $PayloadOutput
      "@
      }
- name: InstallUtil class constructor method call
  description: |
    Executes the installer assembly class constructor.
  supported_platforms:
    - windows
  input_arguments:
    test_harness:
      description: location of the test harness script - Invoke-BuildAndInvokeInstallUtilAssembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\InstallUtilTestHarness.ps1
    payload_dir:
      description: directory to drop the compiled installer assembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\
    payload_filename:
      description: filename of the compiled installer assembly
      type: String
      default: T1118.dll
    invocation_method:
      description: the type of InstallUtil invocation variant - Executable, InstallHelper, or CheckIfInstallable
      type: String
      default: Executable
  executor:
    name: powershell
    elevation_required: false
    command: |
      # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
      . #{test_harness}

      $PayloadDirectory = '#{payload_dir}'
      $PayloadFileName = '#{payload_filename}'
      $PayloadFullPath = Join-Path -Path $PayloadDirectory -ChildPath $PayloadFileName

      $CommandLine = "/logfile= /logtoconsole=false `"$PayloadFullPath`""
      $ExpectedPayloadOutput = 'Constructor_'

      $TestArgs = @{
          OutputAssemblyDirectory = $PayloadDirectory
          OutputAssemblyFileName = $PayloadFileName
          InvocationMethod = '#{invocation_method}'
          CommandLine = $CommandLine
      }

      $PayloadOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs -MinimumViablePayload

      if ($PayloadOutput -ne $ExpectedPayloadOutput) {
          throw @"
      InstallUtil class constructor execution test failure. Payload execution output did not match the expected output.
      Expected: $ExpectedPayloadOutput
      Actual: $PayloadOutput
      "@
      }
- name: InstallUtil Install method call
  description: |
    Executes the Install Method
  supported_platforms:
    - windows
  input_arguments:
    test_harness:
      description: location of the test harness script - Invoke-BuildAndInvokeInstallUtilAssembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\InstallUtilTestHarness.ps1
    payload_dir:
      description: directory to drop the compiled installer assembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\
    payload_filename:
      description: filename of the compiled installer assembly
      type: String
      default: T1118.dll
    invocation_method:
      description: the type of InstallUtil invocation variant - Executable, InstallHelper, or CheckIfInstallable
      type: String
      default: Executable
  executor:
    name: powershell
    elevation_required: false
    command: |
      # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
      . #{test_harness}

      $PayloadDirectory = '#{payload_dir}'
      $PayloadFileName = '#{payload_filename}'
      $PayloadFullPath = Join-Path -Path $PayloadDirectory -ChildPath $PayloadFileName

      $CommandLine = "/logfile= /logtoconsole=false /installtype=notransaction /action=install `"$PayloadFullPath`""
      $ExpectedPayloadOutput = 'Constructor_Install_'

      $TestArgs = @{
          OutputAssemblyDirectory = $PayloadDirectory
          OutputAssemblyFileName = $PayloadFileName
          InvocationMethod = '#{invocation_method}'
          CommandLine = $CommandLine
      }

      $PayloadOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs

      if ($PayloadOutput -ne $ExpectedPayloadOutput) {
          throw @"
      InstallUtil Install method execution test failure. Payload execution output did not match the expected output.
      Expected: $ExpectedPayloadOutput
      Actual: $PayloadOutput
      "@
      }
- name: InstallUtil Uninstall method call - /U variant
  description: |
    Executes the Uninstall Method
  supported_platforms:
    - windows
  input_arguments:
    test_harness:
      description: location of the test harness script - Invoke-BuildAndInvokeInstallUtilAssembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\InstallUtilTestHarness.ps1
    payload_dir:
      description: directory to drop the compiled installer assembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\
    payload_filename:
      description: filename of the compiled installer assembly
      type: String
      default: T1118.dll
    invocation_method:
      description: the type of InstallUtil invocation variant - Executable, InstallHelper, or CheckIfInstallable
      type: String
      default: Executable
  executor:
    name: powershell
    elevation_required: false
    command: |
      # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
      . #{test_harness}

      $PayloadDirectory = '#{payload_dir}'
      $PayloadFileName = '#{payload_filename}'
      $PayloadFullPath = Join-Path -Path $PayloadDirectory -ChildPath $PayloadFileName

      $CommandLine = "/logfile= /logtoconsole=false /U `"$PayloadFullPath`""
      $ExpectedPayloadOutput = 'Constructor_Uninstall_'

      $TestArgs = @{
          OutputAssemblyDirectory = $PayloadDirectory
          OutputAssemblyFileName = $PayloadFileName
          InvocationMethod = '#{invocation_method}'
          CommandLine = $CommandLine
      }

      $PayloadOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs

      if ($PayloadOutput -ne $ExpectedPayloadOutput) {
          throw @"
      InstallUtil Uninstall method execution test failure. Payload execution output did not match the expected output.
      Expected: $ExpectedPayloadOutput
      Actual: $PayloadOutput
      "@
      }
- name: InstallUtil Uninstall method call - '/installtype=notransaction /action=uninstall' variant
  description: |
    Executes the Uninstall Method
  supported_platforms:
    - windows
  input_arguments:
    test_harness:
      description: location of the test harness script - Invoke-BuildAndInvokeInstallUtilAssembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\InstallUtilTestHarness.ps1
    payload_dir:
      description: directory to drop the compiled installer assembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\
    payload_filename:
      description: filename of the compiled installer assembly
      type: String
      default: T1118.dll
    invocation_method:
      description: the type of InstallUtil invocation variant - Executable, InstallHelper, or CheckIfInstallable
      type: String
      default: Executable
  executor:
    name: powershell
    elevation_required: false
    command: |
      # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
      . #{test_harness}

      $PayloadDirectory = '#{payload_dir}'
      $PayloadFileName = '#{payload_filename}'
      $PayloadFullPath = Join-Path -Path $PayloadDirectory -ChildPath $PayloadFileName

      $CommandLine = "/logfile= /logtoconsole=false /installtype=notransaction /action=uninstall `"$PayloadFullPath`""
      $ExpectedPayloadOutput = 'Constructor_Uninstall_'

      $TestArgs = @{
          OutputAssemblyDirectory = $PayloadDirectory
          OutputAssemblyFileName = $PayloadFileName
          InvocationMethod = '#{invocation_method}'
          CommandLine = $CommandLine
      }

      $PayloadOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs

      if ($PayloadOutput -ne $ExpectedPayloadOutput) {
          throw @"
      InstallUtil Uninstall method execution test failure. Payload execution output did not match the expected output.
      Expected: $ExpectedPayloadOutput
      Actual: $PayloadOutput
      "@
      }
- name: InstallUtil HelpText method call
  description: |
    Executes the Uninstall Method
  supported_platforms:
    - windows
  input_arguments:
    test_harness:
      description: location of the test harness script - Invoke-BuildAndInvokeInstallUtilAssembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\InstallUtilTestHarness.ps1
    payload_dir:
      description: directory to drop the compiled installer assembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\
    payload_filename:
      description: filename of the compiled installer assembly
      type: String
      default: T1118.dll
    invocation_method:
      description: the type of InstallUtil invocation variant - Executable, InstallHelper, or CheckIfInstallable
      type: String
      default: Executable
  executor:
    name: powershell
    elevation_required: false
    command: |
      # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
      . #{test_harness}

      $PayloadDirectory = '#{payload_dir}'
      $PayloadFileName = '#{payload_filename}'
      $PayloadFullPath = Join-Path -Path $PayloadDirectory -ChildPath $PayloadFileName

      $CommandLine = "/? `"$PayloadFullPath`""
      $ExpectedPayloadOutput = 'Constructor_HelpText_'

      $TestArgs = @{
          OutputAssemblyDirectory = $PayloadDirectory
          OutputAssemblyFileName = $PayloadFileName
          InvocationMethod = '#{invocation_method}'
          CommandLine = $CommandLine
      }

      $PayloadOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs

      if ($PayloadOutput -ne $ExpectedPayloadOutput) {
          throw @"
      InstallUtil HelpText property execution test failure. Payload execution output did not match the expected output.
      Expected: $ExpectedPayloadOutput
      Actual: $PayloadOutput
      "@
      }
- name: Evasive InstallUtil invocation
  description: |
    Executes an InstallUtil assembly by renaming InstallUtil.exe and using a nonstandard extension for the assembly.
  supported_platforms:
    - windows
  input_arguments:
    test_harness:
      description: location of the test harness script - Invoke-BuildAndInvokeInstallUtilAssembly
      type: Path
      default: PathToAtomicsFolder\T1118\src\InstallUtilTestHarness.ps1
  executor:
    name: powershell
    elevation_required: false
    command: |
      # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
      . #{test_harness}

      $PayloadDirectory = "$Env:windir\System32\Tasks"
      $PayloadFileName = 'readme.txt'
      $PayloadFullPath = Join-Path -Path $PayloadDirectory -ChildPath $PayloadFileName

      $CommandLine = "readme.txt"
      $ExpectedPayloadOutput = 'Constructor_'

      # Explicitly set the directory so that a relative path to readme.txt can be supplied.
      Set-Location "$Env:windir\System32\Tasks"

      Copy-Item -Path "$([System.Runtime.InteropServices.RuntimeEnvironment]::GetRuntimeDirectory())InstallUtil.exe" -Destination "$Env:windir\System32\Tasks\notepad.exe"

      $TestArgs = @{
          OutputAssemblyDirectory = $PayloadDirectory
          OutputAssemblyFileName = $PayloadFileName
          InvocationMethod = 'Executable'
          CommandLine = $CommandLine
          InstallUtilPath = "$Env:windir\System32\Tasks\notepad.exe"
      }

      $PayloadOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs -MinimumViablePayload

      if ($PayloadOutput -ne $ExpectedPayloadOutput) {
          throw @"
      Evasive Installutil invocation test failure. Payload execution output did not match the expected output.
      Expected: $ExpectedPayloadOutput
      Actual: $PayloadOutput
      "@
      }