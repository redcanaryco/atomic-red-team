---
attack_technique: T1560
display_name: Archive Collected Data

atomic_tests:
- name: Compress Data for Exfiltration With PowerShell
  auto_generated_guid: 41410c60-614d-4b9d-b66e-b0192dd9c597
  description: |
    An adversary may compress data (e.g., sensitive documents) that is collected prior to exfiltration.
    When the test completes you should find the files from the $env:USERPROFILE directory compressed in a file called T1560-data-ps.zip in the $env:USERPROFILE directory 
  supported_platforms:
    - windows
  input_arguments:
    input_file:
      description: Path that should be compressed into our output file
      type: Path
      default: $env:USERPROFILE
    output_file:
      description: Path where resulting compressed data should be placed
      type: Path
      default: $env:USERPROFILE\T1560-data-ps.zip
  executor:
    name: powershell
    elevation_required: false
    command: |
      dir #{input_file} -Recurse | Compress-Archive -DestinationPath #{output_file}
    cleanup_command: |
      Remove-Item -path #{output_file} -ErrorAction Ignore

- name: Data Compressed - nix - tar Folder or File
  auto_generated_guid: 7af2b51e-ad1c-498c-aca8-d3290c19535a
  description: |
    An adversary may compress data (e.g., sensitive documents) that is collected prior to exfiltration. This test uses standard gzip compression.
  supported_platforms:
    - linux
    - macos
  input_arguments:
    input_file_folder:
      description: Path that should be compressed
      type: Path
      default: '$HOME/$USERNAME'
    output_file:
      description: File that should be output
      type: Path
      default: '$HOME/data.tar.gz'
  
  dependencies:
    - description: |
        Folder to zip must exist (#{input_file_folder})
      prereq_command: |
        test -e #{input_file_folder}
      get_prereq_command: |
        echo Please set input_file_folder argument to a folder that exists

  executor:
    name: sh
    elevation_required: false
    command: |
      tar -cvzf #{output_file} #{input_file_folder}
    cleanup_command: |
      rm -f #{output_file}

- name: Data Encrypted with zip and gpg symmetric
  auto_generated_guid: 0286eb44-e7ce-41a0-b109-3da516e05a5f
  description: |
    Encrypt data for exiltration
  supported_platforms:
    - macos
    - linux
  input_arguments:
    test_folder:
      description: Path used to store files.
      type: Path
      default: /tmp/T1560
    test_file:
      description: Temp file used to store encrypted data.
      type: Path
      default: T1560
    encryption_password:
      description: Password used to encrypt data.
      type: string
      default: InsertPasswordHere
  dependency_executor_name: sh
  dependencies:
    - description: gpg and zip are required to run the test.
      prereq_command: |
        if [ ! -x "$(command -v gpg)" ] || [ ! -x "$(command -v zip)" ]; then exit 1; fi;
      get_prereq_command: |
        echo "Install gpg and zip to run the test"; exit 1;
  executor:
    name: sh
    elevation_required: false
    command: |
      mkdir -p #{test_folder}
      cd #{test_folder}; touch a b c d e f g
      zip --password "#{encryption_password}" #{test_folder}/#{test_file} ./*
      echo "#{encryption_password}" | gpg --batch --yes --passphrase-fd 0 --output #{test_folder}/#{test_file}.zip.gpg -c #{test_folder}/#{test_file}.zip
      ls -l #{test_folder}
    cleanup_command: |
      rm -Rf #{test_folder}